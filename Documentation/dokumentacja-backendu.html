<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShareWay Enterprise API Specification (v1.0)</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
          Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      h1,
      h2,
      h3 {
        border-bottom: 1px solid #eaecef;
        padding-bottom: 0.3em;
      }
      h1 {
        font-size: 2em;
        font-weight: 600;
      }
      h2 {
        font-size: 1.5em;
        font-weight: 600;
        margin-top: 24px;
      }
      h3 {
        font-size: 1.25em;
        font-weight: 600;
        margin-top: 20px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
        display: block;
        overflow-x: auto;
      }
      th,
      td {
        border: 1px solid #dfe2e5;
        padding: 6px 13px;
        text-align: left;
      }
      th {
        background-color: #f6f8fa;
        font-weight: 600;
      }
      tr:nth-child(2n) {
        background-color: #f6f8fa;
      }
      code {
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo,
          monospace;
        background-color: rgba(27, 31, 35, 0.05);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 85%;
      }
      pre {
        background-color: #f6f8fa;
        border-radius: 3px;
        font-size: 85%;
        line-height: 1.45;
        overflow: auto;
        padding: 16px;
      }
      hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
      }
      blockquote {
        color: #6a737d;
        border-left: 0.25em solid #dfe2e5;
        padding: 0 1em;
        margin-left: 0;
      }
    </style>
  </head>
  <body>
    <h1>üìò ShareWay Enterprise API Specification (v1.0)</h1>
    <ul>
      <li>
        <strong>Base URL:</strong> <code>https://api.shareway.app/api/v1</code>
      </li>
      <li><strong>Protocol:</strong> HTTPS / REST</li>
      <li>
        <strong>Data Format:</strong> JSON (<code>application/json</code>)
      </li>
      <li>
        <strong>Date Format:</strong> ISO 8601 UTC (e.g.,
        <code>2025-11-27T14:30:00Z</code>)
      </li>
    </ul>

    <hr />

    <h2>üõ°Ô∏è 1. Architecture & Security Standards</h2>

    <h3>Authentication Strategy</h3>
    <p>
      We utilize a <strong>Double-Token Architecture</strong> for maximum
      security.
    </p>
    <ul>
      <li>
        <strong>Access Token (JWT):</strong> Short-lived (15 min). Used for
        resource access.
      </li>
      <li>
        <strong>Refresh Token (Opaque Hash):</strong> Long-lived (7 days).
        Stored in Redis (backend) and used to rotate Access Tokens.
      </li>
    </ul>
    <p><strong>Frontend Implementation Rule:</strong></p>
    <ul>
      <li>
        Tokens are strictly transmitted via <code>HttpOnly</code>,
        <code>Secure</code> Cookies.
      </li>
      <li>
        Do not attempt to read tokens from <code>localStorage</code> or response
        bodies.
      </li>
      <li>
        <strong>MUST</strong> set <code>credentials: 'include'</code> on ALL
        requests.
      </li>
    </ul>

    <h3>Deep Ownership Validation (Security Rule)</h3>
    <p>
      To prevent Insecure Direct Object References (IDOR), the backend enforces
      strict ownership chains.
    </p>
    <ul>
      <li>
        <strong>Rule:</strong> For all child resources (Activities, Expenses,
        Votes), the backend <strong>MUST</strong> validate the full chain:
        <code>Resource -> Trip -> Is Requesting User a Participant?</code>
      </li>
      <li>
        <strong>Implementation:</strong> Do not rely solely on the Resource ID.
        Operations must validate the user's membership in the parent Trip before
        processing updates.
      </li>
    </ul>

    <h3>Role Hierarchy (RBAC)</h3>
    <ul>
      <li>
        <strong>ADMIN:</strong> System-wide superuser (can ban users, delete any
        trip, reset passwords).
      </li>
      <li>
        <strong>ORGANIZER:</strong> The creator of a specific Trip. Has write
        access to Trip Settings and can remove participants.
      </li>
      <li>
        <strong>PARTICIPANT:</strong> A member of a specific Trip. Has write
        access to shared modules (Plan, Expenses, Votes).
      </li>
    </ul>

    <hr />

    <h2>üîê 2. Auth Module</h2>
    <p>Session lifecycle management.</p>
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Auth</th>
          <th>Payload</th>
          <th>Description & Logic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/auth/register</code></td>
          <td>Public</td>
          <td><code>RegisterDto</code></td>
          <td>
            Creates User entity. Triggers "Welcome" email. Returns
            <code>201 Created</code>.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/auth/login</code></td>
          <td>Public</td>
          <td><code>LoginDto</code></td>
          <td>
            Validates credentials. Generates tokens. Whitelists Refresh Token in
            Redis. Sets <code>Set-Cookie</code> headers.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/auth/logout</code></td>
          <td>Protected</td>
          <td>-</td>
          <td>
            <strong>Logic:</strong> Removes the current Refresh Token from Redis
            (immediate invalidation) and clears browser cookies.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/auth/refresh</code></td>
          <td>Protected</td>
          <td>-</td>
          <td>
            Call this upon <code>401 Unauthorized</code>. Validates the Refresh
            Cookie against Redis. Rotates tokens (issues new pair).
          </td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h2>üë§ 3. User & Admin Module</h2>
    <p>Identity management. Note: User avatars are not supported in v1.0.</p>
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Auth</th>
          <th>Payload</th>
          <th>Description & Logic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/users/me</code></td>
          <td>Protected</td>
          <td>-</td>
          <td>Returns the profile of the currently logged-in user.</td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/users/me</code></td>
          <td>Protected</td>
          <td><code>UpdateProfileDto</code></td>
          <td>Updates permissible fields (Nickname).</td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/users/me/password</code></td>
          <td>Protected</td>
          <td><code>ChangePasswordDto</code></td>
          <td>
            Allows logged-in user to change their own password. Requires
            <code>oldPassword</code> verification.
          </td>
        </tr>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/admin/users</code></td>
          <td>ADMIN</td>
          <td><code>PageOptionsDto</code></td>
          <td>Lists all users for moderation.</td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/admin/users/:id/ban</code></td>
          <td>ADMIN</td>
          <td><code>{ "isActive": boolean }</code></td>
          <td>
            Deactivates user. <strong>Logic:</strong> Backend immediately purges
            user sessions from Redis.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/admin/users/:id/reset-password</code></td>
          <td>ADMIN</td>
          <td>-</td>
          <td>Generates a temporary password or reset link for the user.</td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h2>‚úàÔ∏è 4. Trip Core Module</h2>
    <p>Trip lifecycle and access control.</p>
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Auth</th>
          <th>Payload</th>
          <th>Description & Logic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips</code></td>
          <td>Protected</td>
          <td>-</td>
          <td>Returns a lightweight list of trips the user is part of.</td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips</code></td>
          <td>Protected</td>
          <td><code>CreateTripDto</code></td>
          <td>
            Creates a Trip. Creator is assigned <strong>ORGANIZER</strong> role.
            Requires <code>baseCurrency</code>.
          </td>
        </tr>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips/:id</code></td>
          <td>Member</td>
          <td>-</td>
          <td>
            Returns <code>TripDto</code> (Metadata + List of Participants).
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips/join</code></td>
          <td>Protected</td>
          <td><code>{ "code": "..." }</code></td>
          <td>
            <strong>Logic:</strong> Validates code exists AND
            <code>expiry > NOW()</code>. Adds user as
            <strong>PARTICIPANT</strong>.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips/:id/invite-code</code></td>
          <td>Organizer</td>
          <td>-</td>
          <td>
            Generates a new random code. <strong>Logic:</strong> Old code
            remains valid for 5 minutes (grace period) to prevent race
            conditions.
          </td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/trips/:id</code></td>
          <td>Organizer</td>
          <td><code>UpdateTripDto</code></td>
          <td>
            Updates Name, Location, Dates, etc. <strong>Logic:</strong> If dates
            change, backend checks for conflicts with existing "Day Buckets".
          </td>
        </tr>
        <tr>
          <td><strong>DELETE</strong></td>
          <td><code>/trips/:id</code></td>
          <td>Organizer</td>
          <td>-</td>
          <td>Soft-deletes the trip.</td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h2>üìÖ 5. Planning Module (Itinerary)</h2>
    <p>Hierarchy: Trip ‚ûî Day ‚ûî Activity.</p>
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Auth</th>
          <th>Payload</th>
          <th>Description & Logic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips/:id/plan</code></td>
          <td>Member</td>
          <td>-</td>
          <td>
            Returns array of <code>DayDto</code>, containing nested
            <code>activities</code>.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips/:id/days</code></td>
          <td>Member</td>
          <td><code>{ "date": "ISO" }</code></td>
          <td>
            Creates a "Day Bucket". <strong>Validation:</strong> Date must be
            within Trip range.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/days/:dayId/activities</code></td>
          <td>Member</td>
          <td><code>CreateActivityDto</code></td>
          <td>
            Adds activity. <strong>Validation:</strong> <code>dayId</code> must
            belong to a Trip the user is in.
          </td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/activities/:id</code></td>
          <td>Member</td>
          <td><code>UpdateActivityDto</code></td>
          <td>Updates time, location, title, or description.</td>
        </tr>
        <tr>
          <td><strong>DELETE</strong></td>
          <td><code>/activities/:id</code></td>
          <td>Member*</td>
          <td>-</td>
          <td>
            Allowed if User is the Creator of the activity OR User is ORGANIZER.
          </td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h2>üí∏ 6. Finance Module</h2>
    <p>
      Expense tracking and Settlement Algorithm. All values are stored in the
      Trip's <code>baseCurrency</code>.
    </p>
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Auth</th>
          <th>Payload</th>
          <th>Description & Logic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips/:id/expenses</code></td>
          <td>Member</td>
          <td>-</td>
          <td>Returns history of expenses as <code>ExpenseDto[]</code>.</td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips/:id/expenses</code></td>
          <td>Member</td>
          <td><code>CreateExpenseDto</code></td>
          <td>
            <strong>Logic:</strong> Payer is defined in payload.
            <code>debtorIds</code> must be active participants.
          </td>
        </tr>
        <tr>
          <td><strong>DELETE</strong></td>
          <td><code>/expenses/:id</code></td>
          <td>Organizer</td>
          <td>-</td>
          <td>Removes expense and triggers balance recalculation.</td>
        </tr>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips/:id/balance</code></td>
          <td>Member</td>
          <td>-</td>
          <td>
            Returns <code>BalanceGraphDto</code>. Optimized settlement graph to
            zero out debts.
          </td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h2>üó≥Ô∏è 7. Engagement Module (Votes & Checklist)</h2>
    <table>
      <thead>
        <tr>
          <th>Method</th>
          <th>Endpoint</th>
          <th>Auth</th>
          <th>Payload</th>
          <th>Description & Logic</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips/:id/votes</code></td>
          <td>Member</td>
          <td>-</td>
          <td>Lists all polls (<code>VoteDto[]</code>).</td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips/:id/votes</code></td>
          <td>Member</td>
          <td><code>CreateVoteDto</code></td>
          <td>Creates a poll with options and optional deadline.</td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/votes/:id</code></td>
          <td>Member*</td>
          <td><code>UpdateVoteDto</code></td>
          <td>Updates poll details. *Creator or Organizer only.*</td>
        </tr>
        <tr>
          <td><strong>DELETE</strong></td>
          <td><code>/votes/:id</code></td>
          <td>Member*</td>
          <td>-</td>
          <td>Deletes the poll. *Creator or Organizer only.*</td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/votes/:voteId/cast</code></td>
          <td>Member</td>
          <td><code>{ "optionIds": [] }</code></td>
          <td>
            Casts vote. Enforces <code>allowMultipleChoice</code> constraints.
          </td>
        </tr>
        <tr>
          <td><strong>DELETE</strong></td>
          <td><code>/votes/:voteId/cast</code></td>
          <td>Member</td>
          <td>-</td>
          <td>Retracts/Removes the user's vote from this poll.</td>
        </tr>
        <tr>
          <td><strong>GET</strong></td>
          <td><code>/trips/:id/checklist</code></td>
          <td>Member</td>
          <td>-</td>
          <td>
            Returns <code>ChecklistItemDto[]</code>. <strong>Logic:</strong>
            <code>isChecked</code> is a computed property specific to the
            requesting User.
          </td>
        </tr>
        <tr>
          <td><strong>POST</strong></td>
          <td><code>/trips/:id/checklist</code></td>
          <td>Member</td>
          <td><code>{ "text": "..." }</code></td>
          <td>Adds a global item to the shared list template.</td>
        </tr>
        <tr>
          <td><strong>DELETE</strong></td>
          <td><code>/checklist/:itemId</code></td>
          <td>Member</td>
          <td>-</td>
          <td>Deletes a checklist item globally.</td>
        </tr>
        <tr>
          <td><strong>PATCH</strong></td>
          <td><code>/checklist/:itemId/status</code></td>
          <td>Member</td>
          <td><code>{ "isChecked": bool }</code></td>
          <td>Toggles the <strong>personal</strong> completion status.</td>
        </tr>
      </tbody>
    </table>

    <hr />

    <h2>üìö Data Structures (DTOs)</h2>

    <h3>1. User & Auth DTOs</h3>
    <p><strong>Request: RegisterDto</strong></p>
    <pre><code class="language-typescript">interface RegisterDto {
  email: string;
  password: string;
  nickname: string;
}</code></pre>

    <p><strong>Request: ChangePasswordDto</strong></p>
    <pre><code class="language-typescript">interface ChangePasswordDto {
  oldPassword: string;
  newPassword: string;
}</code></pre>

    <h3>2. Trip & Core DTOs</h3>
    <p><strong>Request: CreateTripDto / UpdateTripDto</strong></p>
    <pre><code class="language-typescript">interface CreateTripDto {
  name: string;
  description?: string; // Optional description of the trip
  location: string;     // e.g., "Paris, France"
  startDate: string;    // ISO Date
  endDate: string;      // ISO Date
  baseCurrency: string; // REQUIRED. e.g. "USD", "PLN". Cannot be changed later.
}</code></pre>

    <p><strong>Response: TripDto</strong></p>
    <pre><code class="language-typescript">enum TripRole {
  ORGANIZER,
  PARTICIPANT,
}

interface TripDto {
  id: string;
  name: string;
  description?: string;
  location: string;
  startDate: string;
  endDate: string;
  baseCurrency: string;
  myRole: TripRole; // Role of the requesting user
  participants: {
    id: string;
    nickname: string;
    // Avatar removed as per requirements
    role: TripRole;
  }[];
}</code></pre>

    <h3>3. Finance DTOs</h3>
    <p><strong>Request: CreateExpenseDto</strong></p>
    <pre><code class="language-typescript">interface CreateExpenseDto {
  title: string;        // Short title of the expense
  description?: string; // Optional details
  amount: number;       // Integer (cents/smallest unit). e.g. 1000 = 10.00
  date: string;         // ISO Date
  payerId: string;      // ID of the user who paid
  debtorIds?: string[]; // Optional: Specific users to split cost among
  status: "PENDING" | "SETTLED";
}</code></pre>

    <p><strong>Response: BalanceGraphDto (for /balance)</strong></p>
    <pre><code class="language-typescript">interface BalanceTransfer {
  fromUserId: string; // The Debtor (Who pays)
  toUserId: string;   // The Creditor (Who gets paid)
  amount: number;     // In Trip Base Currency
}</code></pre>

    <h3>4. Planning DTOs</h3>
    <p><strong>Request: CreateActivityDto / UpdateActivityDto</strong></p>
    <pre><code class="language-typescript">interface ActivityDto {
  id: string;
  type: "FLIGHT" | "ACCOMMODATION" | "MEETING" | "FOOD" | "OTHER";
  title: string;
  description?: string; // Optional
  startTime: string;    // ISO Date
  endTime: string;      // ISO Date (Required)
  location?: { name: string; lat: number; lng: number };
  creatorId: string;
}</code></pre>

    <p><strong>Response: DayDto (for /plan)</strong></p>
    <pre><code class="language-typescript">interface DayDto {
  id: string;
  date: string; // YYYY-MM-DD
  activities: ActivityDto[];
}</code></pre>

    <h3>5. Engagement DTOs</h3>
    <p><strong>Response: VoteDto</strong></p>
    <pre><code class="language-typescript">interface VoteDto {
  id: string;
  question: string;
  description?: string; // Optional context
  endDate?: string;     // Optional deadline for voting
  status: "OPEN" | "CLOSED";
  options: {
    id: string;
    text: string;
    count: number;
    voterIds: string[];
  }[];
  currentUserSelectionIds: string[]; // Options the current user voted for
}</code></pre>

    <p><strong>Response: ChecklistItemDto</strong></p>
    <pre><code class="language-typescript">interface ChecklistItemDto {
  id: string;
  text: string;
  isChecked: boolean; // Personal status for the requesting user
}</code></pre>
  </body>
</html>
